"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _url = _interopRequireDefault(require("url"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _asyncbox = require("asyncbox");

var _portscanner = require("portscanner");

var _child_process = require("child_process");

var _utils = require("./utils");

const log = _appiumSupport.logger.getLogger('WebDriverAgentMac');

const ROOT_DIR = _path.default.basename(__dirname) === 'lib' ? _path.default.resolve(__dirname, process.env.NO_PRECOMPILE ? '..' : '../..') : __dirname;

const DEFAULT_WDA_ROOT = _path.default.resolve(ROOT_DIR, 'WebDriverAgentMac');

const WDA_PROJECT_NAME = 'WebDriverAgentMac.xcodeproj';

const WDA_PROJECT = (wdaRoot = DEFAULT_WDA_ROOT) => _path.default.resolve(wdaRoot, WDA_PROJECT_NAME);

const RUNNER_SCHEME = 'WebDriverAgentRunner';
const DISABLE_STORE_ARG = 'COMPILER_INDEX_STORE_ENABLE=NO';
const XCODEBUILD = 'xcodebuild';
const STARTUP_TIMEOUT_MS = 120000;
const DEFAULT_SYSTEM_PORT = 10100;
const DEFAULT_SYSTEM_HOST = '127.0.0.1';
const DEFAULT_SHOW_SERVER_LOGS = false;
const RUNNING_PROCESS_IDS = [];

const RECENT_UPGRADE_TIMESTAMP_PATH = _path.default.join('.appium', 'webdriveragent_mac', 'upgrade.time');

async function getUpgradeTimestamp() {
  const packageManifest = _path.default.resolve(ROOT_DIR, 'package.json');

  if (!(await _appiumSupport.fs.exists(packageManifest))) {
    return null;
  }

  const {
    mtime
  } = await _appiumSupport.fs.stat(packageManifest);
  return mtime.getTime();
}

async function cleanupObsoleteProcesses() {
  if (!_lodash.default.isEmpty(RUNNING_PROCESS_IDS)) {
    log.debug(`Cleaning up ${RUNNING_PROCESS_IDS.length} obsolete ` + _appiumSupport.util.pluralize('process', RUNNING_PROCESS_IDS.length, false));

    try {
      await (0, _teen_process.exec)('kill', ['-9', ...RUNNING_PROCESS_IDS]);
    } catch (ign) {}

    _lodash.default.pullAll(RUNNING_PROCESS_IDS, RUNNING_PROCESS_IDS);
  }
}

process.once('exit', () => {
  if (!_lodash.default.isEmpty(RUNNING_PROCESS_IDS)) {
    try {
      (0, _child_process.execSync)(`kill -9 ${RUNNING_PROCESS_IDS.join(' ')}`);
    } catch (ign) {}

    _lodash.default.pullAll(RUNNING_PROCESS_IDS, RUNNING_PROCESS_IDS);
  }
});

class WDAMacProxy extends _appiumBaseDriver.JWProxy {
  async proxyCommand(url, method, body = null) {
    if (this.didProcessExit) {
      throw new _appiumBaseDriver.errors.InvalidContextError(`'${method} ${url}' cannot be proxied to Mac2 Driver server because ` + 'its process is not running (probably crashed). Check the Appium log for more details');
    }

    return await super.proxyCommand(url, method, body);
  }

}

class WDAMacProcess {
  constructor() {
    this.showServerLogs = DEFAULT_SHOW_SERVER_LOGS;
    this.port = DEFAULT_SYSTEM_PORT;
    this.host = DEFAULT_SYSTEM_HOST;
    this.bootstrapRoot = DEFAULT_WDA_ROOT;
    this.proc = null;
  }

  get isRunning() {
    var _this$proc;

    return !!((_this$proc = this.proc) === null || _this$proc === void 0 ? void 0 : _this$proc.isRunning);
  }

  get pid() {
    return this.isRunning ? this.proc.pid : null;
  }

  async listChildrenPids() {
    return this.pid ? await (0, _utils.listChildrenProcessIds)(this.pid) : [];
  }

  async isFreshUpgrade() {
    const homeFolder = process.env.HOME;

    if (!homeFolder) {
      log.info('The HOME folder path cannot be determined');
      return false;
    }

    const currentUpgradeTimestamp = await getUpgradeTimestamp();

    if (!_lodash.default.isInteger(currentUpgradeTimestamp)) {
      log.info('It is impossible to determine the timestamp of the package');
      return false;
    }

    const timestampPath = _path.default.resolve(homeFolder, RECENT_UPGRADE_TIMESTAMP_PATH);

    if (await _appiumSupport.fs.exists(timestampPath)) {
      try {
        await _appiumSupport.fs.access(timestampPath, _appiumSupport.fs.W_OK);
      } catch (ign) {
        log.info(`WebDriverAgent upgrade timestamp at '${timestampPath}' is not writeable`);
        return false;
      }

      const recentUpgradeTimestamp = parseInt(await _appiumSupport.fs.readFile(timestampPath, 'utf8'), 10);

      if (_lodash.default.isInteger(recentUpgradeTimestamp)) {
        if (recentUpgradeTimestamp >= currentUpgradeTimestamp) {
          log.info(`WebDriverAgent sources are up to date ` + `(${recentUpgradeTimestamp} >= ${currentUpgradeTimestamp})`);
          return false;
        }

        log.info(`WebDriverAgent sources have been upgraded ` + `(${recentUpgradeTimestamp} < ${currentUpgradeTimestamp})`);
      } else {
        log.warn(`The recent upgrade timestamp at '${timestampPath}' is corrupted. Trying to fix it`);
      }
    }

    try {
      await (0, _appiumSupport.mkdirp)(_path.default.dirname(timestampPath));
      await _appiumSupport.fs.writeFile(timestampPath, `${currentUpgradeTimestamp}`, 'utf8');
      log.debug(`Stored the recent WebDriverAgent upgrade timestamp ${currentUpgradeTimestamp} ` + `at '${timestampPath}'`);
    } catch (e) {
      log.info(`Unable to create the recent WebDriverAgent upgrade timestamp at '${timestampPath}'. ` + `Original error: ${e.message}`);
      return false;
    }

    return true;
  }

  hasSameOpts({
    showServerLogs,
    systemPort,
    systemHost,
    bootstrapRoot
  }) {
    if (_lodash.default.isBoolean(showServerLogs) && this.showServerLogs !== showServerLogs || _lodash.default.isNil(showServerLogs) && this.showServerLogs !== DEFAULT_SHOW_SERVER_LOGS) {
      return false;
    }

    if (systemPort && this.port !== systemPort || !systemPort && this.port !== DEFAULT_SYSTEM_PORT) {
      return false;
    }

    if (systemHost && this.host !== systemHost || !systemHost && this.host !== DEFAULT_SYSTEM_HOST) {
      return false;
    }

    if (bootstrapRoot && this.bootstrapRoot !== bootstrapRoot || !bootstrapRoot && this.bootstrapRoot !== DEFAULT_WDA_ROOT) {
      return false;
    }

    return true;
  }

  async init(opts = {}) {
    var _opts$showServerLogs, _opts$systemPort, _opts$systemHost, _opts$bootstrapRoot;

    if (this.isRunning && this.hasSameOpts(opts)) {
      return false;
    }

    this.showServerLogs = (_opts$showServerLogs = opts.showServerLogs) !== null && _opts$showServerLogs !== void 0 ? _opts$showServerLogs : this.showServerLogs;
    this.port = (_opts$systemPort = opts.systemPort) !== null && _opts$systemPort !== void 0 ? _opts$systemPort : this.port;
    this.host = (_opts$systemHost = opts.systemHost) !== null && _opts$systemHost !== void 0 ? _opts$systemHost : this.host;
    this.bootstrapRoot = (_opts$bootstrapRoot = opts.bootstrapRoot) !== null && _opts$bootstrapRoot !== void 0 ? _opts$bootstrapRoot : this.bootstrapRoot;
    log.debug(`Using bootstrap root: ${this.bootstrapRoot}`);

    if (!(await _appiumSupport.fs.exists(WDA_PROJECT(this.bootstrapRoot)))) {
      throw new Error(`${WDA_PROJECT_NAME} does not exist at '${WDA_PROJECT(this.bootstrapRoot)}'. ` + `Was 'bootstrapRoot' set to a proper value?`);
    }

    await this.kill();
    await cleanupObsoleteProcesses();
    let xcodebuild;

    try {
      xcodebuild = await _appiumSupport.fs.which(XCODEBUILD);
    } catch (e) {
      throw new Error(`${XCODEBUILD} binary cannot be found in PATH. ` + `Please make sure that Xcode is installed on your system`);
    }

    log.debug(`Using ${XCODEBUILD} binary at '${xcodebuild}'`);

    if (await this.isFreshUpgrade()) {
      log.info('Performing project cleanup');
      const args = ['clean', '-project', WDA_PROJECT(this.bootstrapRoot), '-scheme', RUNNER_SCHEME];

      try {
        await (0, _teen_process.exec)(XCODEBUILD, args, {
          cwd: this.bootstrapRoot
        });
      } catch (e) {
        log.warn(`Cannot perform project cleanup. ` + `Original error: ${e.stderr || e.message}`);
      }
    }

    log.debug(`Using ${this.host} as server host`);
    log.debug(`Using port ${this.port}`);
    const isPortBusy = (await (0, _portscanner.checkPortStatus)(this.port, this.host)) === 'open';

    if (isPortBusy) {
      throw new Error(`The port #${this.port} at ${this.host} is busy. ` + `Consider setting 'systemPort' capability to another free port number and/or ` + `make sure the previous driver session(s) have been closed properly.`);
    }

    const args = ['build-for-testing', 'test-without-building', '-project', WDA_PROJECT(this.bootstrapRoot), '-scheme', RUNNER_SCHEME, DISABLE_STORE_ARG];
    const env = Object.assign({}, process.env, {
      USE_PORT: `${this.port}`,
      USE_HOST: this.host
    });
    this.proc = new _teen_process.SubProcess(xcodebuild, args, {
      cwd: this.bootstrapRoot,
      env
    });

    if (!this.showServerLogs) {
      log.info(`Mac2Driver host process logging is disabled. ` + `All the ${XCODEBUILD} output is going to be suppressed. ` + `Set the 'showServerLogs' capability to 'true' if this is an undesired behavior`);
    }

    this.proc.on('output', (stdout, stderr) => {
      if (!this.showServerLogs) {
        return;
      }

      const line = _lodash.default.trim(stdout || stderr);

      if (line) {
        log.debug(`[${XCODEBUILD}] ${line}`);
      }
    });
    this.proc.on('exit', (code, signal) => {
      log.info(`Mac2Driver host process has exited with code ${code}, signal ${signal}`);
    });
    log.info(`Starting Mac2Driver host process: ${XCODEBUILD} ${_appiumSupport.util.quote(args)}`);
    await this.proc.start(0);
    return true;
  }

  async stop() {
    if (!this.isRunning) {
      return;
    }

    const childrenPids = await this.listChildrenPids();

    if (!_lodash.default.isEmpty(childrenPids)) {
      try {
        await (0, _teen_process.exec)('kill', childrenPids);
      } catch (ign) {}
    }

    await this.proc.stop('SIGTERM', 3000);
  }

  async kill() {
    if (!this.isRunning) {
      return;
    }

    const childrenPids = await this.listChildrenPids();

    if (!_lodash.default.isEmpty(childrenPids)) {
      try {
        await (0, _teen_process.exec)('kill', ['-9', ...childrenPids]);
      } catch (ign) {}
    }

    try {
      await this.proc.stop('SIGKILL');
    } catch (ign) {}
  }

}

class WDAMacServer {
  constructor() {
    this.process = null;
    this.serverStartupTimeoutMs = STARTUP_TIMEOUT_MS;
    this.proxy = null;
    this.isProxyingToRemoteServer = false;
  }

  async isProxyReady(throwOnExit = true) {
    if (!this.proxy) {
      return false;
    }

    try {
      await this.proxy.command('/status', 'GET');
      return true;
    } catch (err) {
      if (throwOnExit && this.proxy.didProcessExit) {
        throw new Error(err.message);
      }

      return false;
    }
  }

  parseProxyProperties(caps) {
    let scheme = 'http';

    if (!caps.webDriverAgentMacUrl) {
      var _ref, _this$process$host, _this$process, _ref2, _this$process$port, _this$process2;

      return {
        scheme,
        server: (_ref = (_this$process$host = (_this$process = this.process) === null || _this$process === void 0 ? void 0 : _this$process.host) !== null && _this$process$host !== void 0 ? _this$process$host : caps.systemHost) !== null && _ref !== void 0 ? _ref : DEFAULT_SYSTEM_HOST,
        port: (_ref2 = (_this$process$port = (_this$process2 = this.process) === null || _this$process2 === void 0 ? void 0 : _this$process2.port) !== null && _this$process$port !== void 0 ? _this$process$port : caps.systemPort) !== null && _ref2 !== void 0 ? _ref2 : DEFAULT_SYSTEM_PORT,
        path: ''
      };
    }

    let parsedUrl;

    try {
      parsedUrl = new _url.default.URL(caps.webDriverAgentMacUrl);
    } catch (e) {
      throw new Error(`webDriverAgentMacUrl, '${caps.webDriverAgentMacUrl}', ` + `in the capabilities is invalid. ${e.message}`);
    }

    const {
      protocol,
      hostname,
      port,
      pathname
    } = parsedUrl;

    if (_lodash.default.isString(protocol)) {
      scheme = protocol.split(':')[0];
    }

    return {
      scheme,
      server: hostname !== null && hostname !== void 0 ? hostname : DEFAULT_SYSTEM_HOST,
      port: _lodash.default.isEmpty(port) ? DEFAULT_SYSTEM_PORT : _lodash.default.parseInt(port),
      path: pathname === '/' ? '' : pathname
    };
  }

  async startSession(caps) {
    var _caps$serverStartupTi;

    this.serverStartupTimeoutMs = (_caps$serverStartupTi = caps.serverStartupTimeout) !== null && _caps$serverStartupTi !== void 0 ? _caps$serverStartupTi : this.serverStartupTimeoutMs;
    this.isProxyingToRemoteServer = !!caps.webDriverAgentMacUrl;
    let wasProcessInitNecessary;

    if (this.isProxyingToRemoteServer) {
      if (this.process) {
        await this.process.kill();
        await cleanupObsoleteProcesses();
        this.process = null;
      }

      wasProcessInitNecessary = false;
    } else {
      if (!this.process) {
        this.process = new WDAMacProcess();
      }

      wasProcessInitNecessary = await this.process.init(caps);
    }

    if (wasProcessInitNecessary || this.isProxyingToRemoteServer || !this.proxy) {
      const {
        scheme,
        server,
        port,
        path
      } = this.parseProxyProperties(caps);
      this.proxy = new WDAMacProxy({
        scheme,
        server,
        port,
        base: path,
        keepAlive: true
      });
      this.proxy.didProcessExit = false;

      if (this.process) {
        this.process.proc.on('exit', () => {
          this.proxy.didProcessExit = true;
        });
      }

      const timer = new _appiumSupport.timing.Timer().start();

      try {
        await (0, _asyncbox.waitForCondition)(async () => await this.isProxyReady(), {
          waitMs: this.serverStartupTimeoutMs,
          intervalMs: 1000
        });
      } catch (e) {
        var _this$process3;

        if ((_this$process3 = this.process) === null || _this$process3 === void 0 ? void 0 : _this$process3.isRunning) {
          await this.process.kill();
        }

        if (/Condition unmet/.test(e.message)) {
          const msg = this.isProxyingToRemoteServer ? `No response from '${scheme}://${server}:${port}${path}' within ${this.serverStartupTimeoutMs}ms timeout.` + `Please make sure the remote server is running and accessible by Appium` : `Mac2Driver server is not listening within ${this.serverStartupTimeoutMs}ms timeout. ` + `Try to increase the value of 'serverStartupTimeout' capability, check the server logs ` + `and make sure the ${XCODEBUILD} host process could be started manually from a terminal`;
          throw new Error(msg);
        }

        throw e;
      }

      if (this.process) {
        const pid = this.process.pid;
        const childrenPids = await this.process.listChildrenPids();
        RUNNING_PROCESS_IDS.push(...childrenPids, pid);
        this.process.proc.on('exit', () => void _lodash.default.pull(RUNNING_PROCESS_IDS, pid));
        log.info(`The host process is ready within ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
      }
    } else {
      log.info('The host process has already been listening. Proceeding with session creation');
    }

    await this.proxy.command('/session', 'POST', {
      capabilities: {
        firstMatch: [{}],
        alwaysMatch: caps
      }
    });
  }

  async stopSession() {
    var _this$process4, _this$proxy;

    if (!this.isProxyingToRemoteServer && !((_this$process4 = this.process) === null || _this$process4 === void 0 ? void 0 : _this$process4.isRunning)) {
      log.info(`Mac2Driver session cannot be stopped, because the server is not running`);
      return;
    }

    if ((_this$proxy = this.proxy) === null || _this$proxy === void 0 ? void 0 : _this$proxy.sessionId) {
      try {
        await this.proxy.command(`/session/${this.proxy.sessionId}`, 'DELETE');
      } catch (e) {
        log.info(`Mac2Driver session cannot be deleted. Original error: ${e.message}`);
      }
    }
  }

}

const WDA_MAC_SERVER = new WDAMacServer();
var _default = WDA_MAC_SERVER;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZGEtbWFjLmpzIl0sIm5hbWVzIjpbImxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsIlJPT1RfRElSIiwicGF0aCIsImJhc2VuYW1lIiwiX19kaXJuYW1lIiwicmVzb2x2ZSIsInByb2Nlc3MiLCJlbnYiLCJOT19QUkVDT01QSUxFIiwiREVGQVVMVF9XREFfUk9PVCIsIldEQV9QUk9KRUNUX05BTUUiLCJXREFfUFJPSkVDVCIsIndkYVJvb3QiLCJSVU5ORVJfU0NIRU1FIiwiRElTQUJMRV9TVE9SRV9BUkciLCJYQ09ERUJVSUxEIiwiU1RBUlRVUF9USU1FT1VUX01TIiwiREVGQVVMVF9TWVNURU1fUE9SVCIsIkRFRkFVTFRfU1lTVEVNX0hPU1QiLCJERUZBVUxUX1NIT1dfU0VSVkVSX0xPR1MiLCJSVU5OSU5HX1BST0NFU1NfSURTIiwiUkVDRU5UX1VQR1JBREVfVElNRVNUQU1QX1BBVEgiLCJqb2luIiwiZ2V0VXBncmFkZVRpbWVzdGFtcCIsInBhY2thZ2VNYW5pZmVzdCIsImZzIiwiZXhpc3RzIiwibXRpbWUiLCJzdGF0IiwiZ2V0VGltZSIsImNsZWFudXBPYnNvbGV0ZVByb2Nlc3NlcyIsIl8iLCJpc0VtcHR5IiwiZGVidWciLCJsZW5ndGgiLCJ1dGlsIiwicGx1cmFsaXplIiwiaWduIiwicHVsbEFsbCIsIm9uY2UiLCJXREFNYWNQcm94eSIsIkpXUHJveHkiLCJwcm94eUNvbW1hbmQiLCJ1cmwiLCJtZXRob2QiLCJib2R5IiwiZGlkUHJvY2Vzc0V4aXQiLCJlcnJvcnMiLCJJbnZhbGlkQ29udGV4dEVycm9yIiwiV0RBTWFjUHJvY2VzcyIsImNvbnN0cnVjdG9yIiwic2hvd1NlcnZlckxvZ3MiLCJwb3J0IiwiaG9zdCIsImJvb3RzdHJhcFJvb3QiLCJwcm9jIiwiaXNSdW5uaW5nIiwicGlkIiwibGlzdENoaWxkcmVuUGlkcyIsImlzRnJlc2hVcGdyYWRlIiwiaG9tZUZvbGRlciIsIkhPTUUiLCJpbmZvIiwiY3VycmVudFVwZ3JhZGVUaW1lc3RhbXAiLCJpc0ludGVnZXIiLCJ0aW1lc3RhbXBQYXRoIiwiYWNjZXNzIiwiV19PSyIsInJlY2VudFVwZ3JhZGVUaW1lc3RhbXAiLCJwYXJzZUludCIsInJlYWRGaWxlIiwid2FybiIsImRpcm5hbWUiLCJ3cml0ZUZpbGUiLCJlIiwibWVzc2FnZSIsImhhc1NhbWVPcHRzIiwic3lzdGVtUG9ydCIsInN5c3RlbUhvc3QiLCJpc0Jvb2xlYW4iLCJpc05pbCIsImluaXQiLCJvcHRzIiwiRXJyb3IiLCJraWxsIiwieGNvZGVidWlsZCIsIndoaWNoIiwiYXJncyIsImN3ZCIsInN0ZGVyciIsImlzUG9ydEJ1c3kiLCJPYmplY3QiLCJhc3NpZ24iLCJVU0VfUE9SVCIsIlVTRV9IT1NUIiwiU3ViUHJvY2VzcyIsIm9uIiwic3Rkb3V0IiwibGluZSIsInRyaW0iLCJjb2RlIiwic2lnbmFsIiwicXVvdGUiLCJzdGFydCIsInN0b3AiLCJjaGlsZHJlblBpZHMiLCJXREFNYWNTZXJ2ZXIiLCJzZXJ2ZXJTdGFydHVwVGltZW91dE1zIiwicHJveHkiLCJpc1Byb3h5aW5nVG9SZW1vdGVTZXJ2ZXIiLCJpc1Byb3h5UmVhZHkiLCJ0aHJvd09uRXhpdCIsImNvbW1hbmQiLCJlcnIiLCJwYXJzZVByb3h5UHJvcGVydGllcyIsImNhcHMiLCJzY2hlbWUiLCJ3ZWJEcml2ZXJBZ2VudE1hY1VybCIsInNlcnZlciIsInBhcnNlZFVybCIsIlVSTCIsInByb3RvY29sIiwiaG9zdG5hbWUiLCJwYXRobmFtZSIsImlzU3RyaW5nIiwic3BsaXQiLCJzdGFydFNlc3Npb24iLCJzZXJ2ZXJTdGFydHVwVGltZW91dCIsIndhc1Byb2Nlc3NJbml0TmVjZXNzYXJ5IiwiYmFzZSIsImtlZXBBbGl2ZSIsInRpbWVyIiwidGltaW5nIiwiVGltZXIiLCJ3YWl0TXMiLCJpbnRlcnZhbE1zIiwidGVzdCIsIm1zZyIsInB1c2giLCJwdWxsIiwiZ2V0RHVyYXRpb24iLCJhc01pbGxpU2Vjb25kcyIsInRvRml4ZWQiLCJjYXBhYmlsaXRpZXMiLCJmaXJzdE1hdGNoIiwiYWx3YXlzTWF0Y2giLCJzdG9wU2Vzc2lvbiIsInNlc3Npb25JZCIsIldEQV9NQUNfU0VSVkVSIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLEdBQUcsR0FBR0Msc0JBQU9DLFNBQVAsQ0FBaUIsbUJBQWpCLENBQVo7O0FBRUEsTUFBTUMsUUFBUSxHQUFHQyxjQUFLQyxRQUFMLENBQWNDLFNBQWQsTUFBNkIsS0FBN0IsR0FDYkYsY0FBS0csT0FBTCxDQUFhRCxTQUFiLEVBQXdCRSxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsYUFBWixHQUE0QixJQUE1QixHQUFtQyxPQUEzRCxDQURhLEdBRWJKLFNBRko7O0FBR0EsTUFBTUssZ0JBQWdCLEdBQUdQLGNBQUtHLE9BQUwsQ0FBYUosUUFBYixFQUF1QixtQkFBdkIsQ0FBekI7O0FBQ0EsTUFBTVMsZ0JBQWdCLEdBQUcsNkJBQXpCOztBQUNBLE1BQU1DLFdBQVcsR0FBRyxDQUFDQyxPQUFPLEdBQUdILGdCQUFYLEtBQWdDUCxjQUFLRyxPQUFMLENBQWFPLE9BQWIsRUFBc0JGLGdCQUF0QixDQUFwRDs7QUFDQSxNQUFNRyxhQUFhLEdBQUcsc0JBQXRCO0FBQ0EsTUFBTUMsaUJBQWlCLEdBQUcsZ0NBQTFCO0FBQ0EsTUFBTUMsVUFBVSxHQUFHLFlBQW5CO0FBQ0EsTUFBTUMsa0JBQWtCLEdBQUcsTUFBM0I7QUFDQSxNQUFNQyxtQkFBbUIsR0FBRyxLQUE1QjtBQUNBLE1BQU1DLG1CQUFtQixHQUFHLFdBQTVCO0FBQ0EsTUFBTUMsd0JBQXdCLEdBQUcsS0FBakM7QUFDQSxNQUFNQyxtQkFBbUIsR0FBRyxFQUE1Qjs7QUFDQSxNQUFNQyw2QkFBNkIsR0FBR25CLGNBQUtvQixJQUFMLENBQVUsU0FBVixFQUNwQyxvQkFEb0MsRUFDZCxjQURjLENBQXRDOztBQUlBLGVBQWVDLG1CQUFmLEdBQXNDO0FBQ3BDLFFBQU1DLGVBQWUsR0FB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RSxDQUFQLEVBQVU7QUFDVjVFLFFBQUFBLEdBQUcsQ0FBQ2dFLElBQUosQ0FBVSx5REFBd0RZLENBQUMsQ0FBQ0MsT0FBUSxFQUE1RTtBQUNEO0FBQ0Y7QUFDRjs7QUF2S2dCOztBQTBLbkIsTUFBTXlFLGNBQWMsR0FBRyxJQUFJMUMsWUFBSixFQUF2QjtlQUVlMEMsYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcbmltcG9ydCB7IEpXUHJveHksIGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBmcywgbG9nZ2VyLCB1dGlsLCB0aW1pbmcsIG1rZGlycCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IFN1YlByb2Nlc3MsIGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IGNoZWNrUG9ydFN0YXR1cyB9IGZyb20gJ3BvcnRzY2FubmVyJztcbmltcG9ydCB7IGV4ZWNTeW5jIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgeyBsaXN0Q2hpbGRyZW5Qcm9jZXNzSWRzIH0gZnJvbSAnLi91dGlscyc7XG5cbmNvbnN0IGxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ1dlYkRyaXZlckFnZW50TWFjJyk7XG5cbmNvbnN0IFJPT1RfRElSID0gcGF0aC5iYXNlbmFtZShfX2Rpcm5hbWUpID09PSAnbGliJ1xuICA/IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIHByb2Nlc3MuZW52Lk5PX1BSRUNPTVBJTEUgPyAnLi4nIDogJy4uLy4uJylcbiAgOiBfX2Rpcm5hbWU7XG5jb25zdCBERUZBVUxUX1dEQV9ST09UID0gcGF0aC5yZXNvbHZlKFJPT1RfRElSLCAnV2ViRHJpdmVyQWdlbnRNYWMnKTtcbmNvbnN0IFdEQV9QUk9KRUNUX05BTUUgPSAnV2ViRHJpdmVyQWdlbnRNYWMueGNvZGVwcm9qJztcbmNvbnN0IFdEQV9QUk9KRUNUID0gKHdkYVJvb3QgPSBERUZBVUxUX1dEQV9ST09UKSA9PiBwYXRoLnJlc29sdmUod2RhUm9vdCwgV0RBX1BST0pFQ1RfTkFNRSk7XG5jb25zdCBSVU5ORVJfU0NIRU1FID0gJ1dlYkRyaXZlckFnZW50UnVubmVyJztcbmNvbnN0IERJU0FCTEVfU1RPUkVfQVJHID0gJ0NPTVBJTEVSX0lOREVYX1NUT1JFX0VOQUJMRT1OTyc7XG5jb25zdCBYQ09ERUJVSUxEID0gJ3hjb2RlYnVpbGQnO1xuY29uc3QgU1RBUlRVUF9USU1FT1VUX01TID0gMTIwMDAwO1xuY29uc3QgREVGQVVMVF9TWVNURU1fUE9SVCA9IDEwMTAwO1xuY29uc3QgREVGQVVMVF9TWVNURU1fSE9TVCA9ICcxMjcuMC4wLjEnO1xuY29uc3QgREVGQVVMVF9TSE9XX1NFUlZFUl9MT0dTID0gZmFsc2U7XG5jb25zdCBSVU5OSU5HX1BST0NFU1NfSURTID0gW107XG5jb25zdCBSRUNFTlRfVVBHUkFERV9USU1FU1RBTVBfUEFUSCA9IHBhdGguam9pbignLmFwcGl1bScsXG4gICd3ZWJkcml2ZXJhZ2VudF9tYWMnLCAndXBncmFkZS50aW1lJyk7XG5cblxuYXN5bmMgZnVuY3Rpb24gZ2V0VXBncmFkZVRpbWVzdGFtcCAoKSB7XG4gIGNvbnN0IHBhY2thZ2VNYW5pZmVzdCA9IHBhdGgucmVzb2x2ZShST09UX0RJUiwgJ3BhY2thZ2UuanNvbicpO1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhwYWNrYWdlTWFuaWZlc3QpKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgY29uc3Qge210aW1lfSA9IGF3YWl0IGZzLnN0YXQocGFja2FnZU1hbmlmZXN0KTtcbiAgcmV0dXJuIG10aW1lLmdldFRpbWUoKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2xlYW51cE9ic29sZXRlUHJvY2Vzc2VzICgpIHtcbiAgaWYgKCFfLmlzRW1wdHkoUlVOTklOR19QUk9DRVNTX0lEUykpIHtcbiAgICBsb2cuZGVidWcoYENsZWFuaW5nIHVwICR7UlVOTklOR19QUk9DRVNTX0lEUy5sZW5ndGh9IG9ic29sZXRlIGAgK1xuICAgICAgdXRpbC5wbHVyYWxpemUoJ3Byb2Nlc3MnLCBSVU5OSU5HX1BST0NFU1NfSURTLmxlbmd0aCwgZmFsc2UpKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZXhlYygna2lsbCcsIFsnLTknLCAuLi5SVU5OSU5HX1BST0NFU1NfSURTXSk7XG4gICAgfSBjYXRjaCAoaWduKSB7fVxuICAgIF8ucHVsbEFsbChSVU5OSU5HX1BST0NFU1NfSURTLCBSVU5OSU5HX1BST0NFU1NfSURTKTtcbiAgfVxufVxuXG5wcm9jZXNzLm9uY2UoJ2V4aXQnLCAoKSA9PiB7XG4gIGlmICghXy5pc0VtcHR5KFJVTk5JTkdfUFJPQ0VTU19JRFMpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGV4ZWNTeW5jKGBraWxsIC05ICR7UlVOTklOR19QUk9DRVNTX0lEUy5qb2luKCcgJyl9YCk7XG4gICAgfSBjYXRjaCAoaWduKSB7fVxuICAgIF8ucHVsbEFsbChSVU5OSU5HX1BST0NFU1NfSURTLCBSVU5OSU5HX1BST0NFU1NfSURTKTtcbiAgfVxufSk7XG5cblxuY2xhc3MgV0RBTWFjUHJveHkgZXh0ZW5kcyBKV1Byb3h5IHtcbiAgYXN5bmMgcHJveHlDb21tYW5kICh1cmwsIG1ldGhvZCwgYm9keSA9IG51bGwpIHtcbiAgICBpZiAodGhpcy5kaWRQcm9jZXNzRXhpdCkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkQ29udGV4dEVycm9yKFxuICAgICAgICBgJyR7bWV0aG9kfSAke3VybH0nIGNhbm5vdCBiZSBwcm94aWVkIHRvIE1hYzIgRHJpdmVyIHNlcnZlciBiZWNhdXNlIGAgK1xuICAgICAgICAnaXRzIHByb2Nlc3MgaXMgbm90IHJ1bm5pbmcgKHByb2JhYmx5IGNyYXNoZWQpLiBDaGVjayB0aGUgQXBwaXVtIGxvZyBmb3IgbW9yZSBkZXRhaWxzJyk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCBzdXBlci5wcm94eUNvbW1hbmQodXJsLCBtZXRob2QsIGJvZHkpO1xuICB9XG59XG5cbmNsYXNzIFdEQU1hY1Byb2Nlc3Mge1xuICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgdGhpcy5zaG93U2VydmVyTG9ncyA9IERFRkFVTFRfU0hPV19TRVJWRVJfTE9HUztcbiAgICB0aGlzLnBvcnQgPSBERUZBVUxUX1NZU1RFTV9QT1JUO1xuICAgIHRoaXMuaG9zdCA9IERFRkFVTFRfU1lTVEVNX0hPU1Q7XG4gICAgdGhpcy5ib290c3RyYXBSb290ID0gREVGQVVMVF9XREFfUk9PVDtcbiAgICB0aGlzLnByb2MgPSBudWxsO1xuICB9XG5cbiAgZ2V0IGlzUnVubmluZyAoKSB7XG4gICAgcmV0dXJuICEhKHRoaXMucHJvYz8uaXNSdW5uaW5nKTtcbiAgfVxuXG4gIGdldCBwaWQgKCkge1xuICAgIHJldHVybiB0aGlzLmlzUnVubmluZyA/IHRoaXMucHJvYy5waWQgOiBudWxsO1xuICB9XG5cbiAgYXN5bmMgbGlzdENoaWxkcmVuUGlkcyAoKSB7XG4gICAgcmV0dXJuIHRoaXMucGlkID8gKGF3YWl0IGxpc3RDaGlsZHJlblByb2Nlc3NJZHModGhpcy5waWQpKSA6IFtdO1xuICB9XG5cbiAgYXN5bmMgaXNGcmVzaFVwZ3JhZGUgKCkge1xuICAgIGNvbnN0IGhvbWVGb2xkZXIgPSBwcm9jZXNzLmVudi5IT01FO1xuICAgIGlmICghaG9tZUZvbGRlcikge1xuICAgICAgbG9nLmluZm8oJ1RoZSBIT01FIGZvbGRlciBwYXRoIGNhbm5vdCBiZSBkZXRlcm1pbmVkJyk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgY29uc3QgY3VycmVudFVwZ3JhZGVUaW1lc3RhbXAgPSBhd2FpdCBnZXRVcGdyYWRlVGltZXN0YW1wKCk7XG4gICAgaWYgKCFfLmlzSW50ZWdlcihjdXJyZW50VXBncmFkZVRpbWVzdGFtcCkpIHtcbiAgICAgIGxvZy5pbmZvKCdJdCBpcyBpbXBvc3NpYmxlIHRvIGRldGVybWluZSB0aGUgdGltZXN0YW1wIG9mIHRoZSBwYWNrYWdlJyk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgY29uc3QgdGltZXN0YW1wUGF0aCA9IHBhdGgucmVzb2x2ZShob21lRm9sZGVyLCBSRUNFTlRfVVBHUkFERV9USU1FU1RBTVBfUEFUSCk7XG4gICAgaWYgKGF3YWl0IGZzLmV4aXN0cyh0aW1lc3RhbXBQYXRoKSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgZnMuYWNjZXNzKHRpbWVzdGFtcFBhdGgsIGZzLldfT0spO1xuICAgICAgfSBjYXRjaCAoaWduKSB7XG4gICAgICAgIGxvZy5pbmZvKGBXZWJEcml2ZXJBZ2VudCB1cGdyYWRlIHRpbWVzdGFtcCBhdCAnJHt0aW1lc3RhbXBQYXRofScgaXMgbm90IHdyaXRlYWJsZWApO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICBjb25zdCByZWNlbnRVcGdyYWRlVGltZXN0YW1wID0gcGFyc2VJbnQoYXdhaXQgZnMucmVhZEZpbGUodGltZXN0YW1wUGF0aCwgJ3V0ZjgnKSwgMTApO1xuICAgICAgaWYgKF8uaXNJbnRlZ2VyKHJlY2VudFVwZ3JhZGVUaW1lc3RhbXApKSB7XG4gICAgICAgIGlmIChyZWNlbnRVcGdyYWRlVGltZXN0YW1wID49IGN1cnJlbnRVcGdyYWRlVGltZXN0YW1wKSB7XG4gICAgICAgICAgbG9nLmluZm8oYFdlYkRyaXZlckFnZW50IHNvdXJjZXMgYXJlIHVwIHRvIGRhdGUgYCArXG4gICAgICAgICAgICBgKCR7cmVjZW50VXBncmFkZVRpbWVzdGFtcH0gPj0gJHtjdXJyZW50VXBncmFkZVRpbWVzdGFtcH0pYCk7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGxvZy5pbmZvKGBXZWJEcml2ZXJBZ2VudCBzb3VyY2VzIGhhdmUgYmVlbiB1cGdyYWRlZCBgICtcbiAgICAgICAgICBgKCR7cmVjZW50VXBncmFkZVRpbWVzdGFtcH0gPCAke2N1cnJlbnRVcGdyYWRlVGltZXN0YW1wfSlgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy53YXJuKGBUaGUgcmVjZW50IHVwZ3JhZGUgdGltZXN0YW1wIGF0ICcke3RpbWVzdGFtcFBhdGh9JyBpcyBjb3JydXB0ZWQuIFRyeWluZyB0byBmaXggaXRgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgbWtkaXJwKHBhdGguZGlybmFtZSh0aW1lc3RhbXBQYXRoKSk7XG4gICAgICBhd2FpdCBmcy53cml0ZUZpbGUodGltZXN0YW1wUGF0aCwgYCR7Y3VycmVudFVwZ3JhZGVUaW1lc3RhbXB9YCwgJ3V0ZjgnKTtcbiAgICAgIGxvZy5kZWJ1ZyhgU3RvcmVkIHRoZSByZWNlbnQgV2ViRHJpdmVyQWdlbnQgdXBncmFkZSB0aW1lc3RhbXAgJHtjdXJyZW50VXBncmFkZVRpbWVzdGFtcH0gYCArXG4gICAgICAgIGBhdCAnJHt0aW1lc3RhbXBQYXRofSdgKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cuaW5mbyhgVW5hYmxlIHRvIGNyZWF0ZSB0aGUgcmVjZW50IFdlYkRyaXZlckFnZW50IHVwZ3JhZGUgdGltZXN0YW1wIGF0ICcke3RpbWVzdGFtcFBhdGh9Jy4gYCArXG4gICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBoYXNTYW1lT3B0cyAoeyBzaG93U2VydmVyTG9ncywgc3lzdGVtUG9ydCwgc3lzdGVtSG9zdCwgYm9vdHN0cmFwUm9vdCB9KSB7XG4gICAgaWYgKF8uaXNCb29sZWFuKHNob3dTZXJ2ZXJMb2dzKSAmJiB0aGlzLnNob3dTZXJ2ZXJMb2dzICE9PSBzaG93U2VydmVyTG9nc1xuICAgICAgfHwgXy5pc05pbChzaG93U2VydmVyTG9ncykgJiYgdGhpcy5zaG93U2VydmVyTG9ncyAhPT0gREVGQVVMVF9TSE9XX1NFUlZFUl9MT0dTKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmIChzeXN0ZW1Qb3J0ICYmIHRoaXMucG9ydCAhPT0gc3lzdGVtUG9ydFxuICAgICAgfHwgIXN5c3RlbVBvcnQgJiYgdGhpcy5wb3J0ICE9PSBERUZBVUxUX1NZU1RFTV9QT1JUKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmIChzeXN0ZW1Ib3N0ICYmIHRoaXMuaG9zdCAhPT0gc3lzdGVtSG9zdFxuICAgICAgfHwgIXN5c3RlbUhvc3QgJiYgdGhpcy5ob3N0ICE9PSBERUZBVUxUX1NZU1RFTV9IT1NUKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGlmIChib290c3RyYXBSb290ICYmIHRoaXMuYm9vdHN0cmFwUm9vdCAhPT0gYm9vdHN0cmFwUm9vdFxuICAgICAgfHwgIWJvb3RzdHJhcFJvb3QgJiYgdGhpcy5ib290c3RyYXBSb290ICE9PSBERUZBVUxUX1dEQV9ST09UKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBhc3luYyBpbml0IChvcHRzID0ge30pIHtcbiAgICBpZiAodGhpcy5pc1J1bm5pbmcgJiYgdGhpcy5oYXNTYW1lT3B0cyhvcHRzKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHRoaXMuc2hvd1NlcnZlckxvZ3MgPSBvcHRzLnNob3dTZXJ2ZXJMb2dzID8/IHRoaXMuc2hvd1NlcnZlckxvZ3M7XG4gICAgdGhpcy5wb3J0ID0gb3B0cy5zeXN0ZW1Qb3J0ID8/IHRoaXMucG9ydDtcbiAgICB0aGlzLmhvc3QgPSBvcHRzLnN5c3RlbUhvc3QgPz8gdGhpcy5ob3N0O1xuICAgIHRoaXMuYm9vdHN0cmFwUm9vdCA9IG9wdHMuYm9vdHN0cmFwUm9vdCA/PyB0aGlzLmJvb3RzdHJhcFJvb3Q7XG5cbiAgICBsb2cuZGVidWcoYFVzaW5nIGJvb3RzdHJhcCByb290OiAke3RoaXMuYm9vdHN0cmFwUm9vdH1gKTtcbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhXREFfUFJPSkVDVCh0aGlzLmJvb3RzdHJhcFJvb3QpKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke1dEQV9QUk9KRUNUX05BTUV9IGRvZXMgbm90IGV4aXN0IGF0ICcke1dEQV9QUk9KRUNUKHRoaXMuYm9vdHN0cmFwUm9vdCl9Jy4gYCArXG4gICAgICAgIGBXYXMgJ2Jvb3RzdHJhcFJvb3QnIHNldCB0byBhIHByb3BlciB2YWx1ZT9gKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLmtpbGwoKTtcbiAgICBhd2FpdCBjbGVhbnVwT2Jzb2xldGVQcm9jZXNzZXMoKTtcblxuICAgIGxldCB4Y29kZWJ1aWxkO1xuICAgIHRyeSB7XG4gICAgICB4Y29kZWJ1aWxkID0gYXdhaXQgZnMud2hpY2goWENPREVCVUlMRCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke1hDT0RFQlVJTER9IGJpbmFyeSBjYW5ub3QgYmUgZm91bmQgaW4gUEFUSC4gYCArXG4gICAgICAgIGBQbGVhc2UgbWFrZSBzdXJlIHRoYXQgWGNvZGUgaXMgaW5zdGFsbGVkIG9uIHlvdXIgc3lzdGVtYCk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgVXNpbmcgJHtYQ09ERUJVSUxEfSBiaW5hcnkgYXQgJyR7eGNvZGVidWlsZH0nYCk7XG5cbiAgICBpZiAoYXdhaXQgdGhpcy5pc0ZyZXNoVXBncmFkZSgpKSB7XG4gICAgICBsb2cuaW5mbygnUGVyZm9ybWluZyBwcm9qZWN0IGNsZWFudXAnKTtcbiAgICAgIGNvbnN0IGFyZ3MgPSBbXG4gICAgICAgICdjbGVhbicsXG4gICAgICAgICctcHJvamVjdCcsIFdEQV9QUk9KRUNUKHRoaXMuYm9vdHN0cmFwUm9vdCksXG4gICAgICAgICctc2NoZW1lJywgUlVOTkVSX1NDSEVNRSxcbiAgICAgIF07XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBleGVjKFhDT0RFQlVJTEQsIGFyZ3MsIHtcbiAgICAgICAgICBjd2Q6IHRoaXMuYm9vdHN0cmFwUm9vdCxcbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy53YXJuKGBDYW5ub3QgcGVyZm9ybSBwcm9qZWN0IGNsZWFudXAuIGAgK1xuICAgICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLnN0ZGVyciB8fCBlLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbG9nLmRlYnVnKGBVc2luZyAke3RoaXMuaG9zdH0gYXMgc2VydmVyIGhvc3RgKTtcbiAgICBsb2cuZGVidWcoYFVzaW5nIHBvcnQgJHt0aGlzLnBvcnR9YCk7XG4gICAgY29uc3QgaXNQb3J0QnVzeSA9IChhd2FpdCBjaGVja1BvcnRTdGF0dXModGhpcy5wb3J0LCB0aGlzLmhvc3QpKSA9PT0gJ29wZW4nO1xuICAgIGlmIChpc1BvcnRCdXN5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBwb3J0ICMke3RoaXMucG9ydH0gYXQgJHt0aGlzLmhvc3R9IGlzIGJ1c3kuIGAgK1xuICAgICAgICBgQ29uc2lkZXIgc2V0dGluZyAnc3lzdGVtUG9ydCcgY2FwYWJpbGl0eSB0byBhbm90aGVyIGZyZWUgcG9ydCBudW1iZXIgYW5kL29yIGAgK1xuICAgICAgICBgbWFrZSBzdXJlIHRoZSBwcmV2aW91cyBkcml2ZXIgc2Vzc2lvbihzKSBoYXZlIGJlZW4gY2xvc2VkIHByb3Blcmx5LmApO1xuICAgIH1cblxuICAgIGNvbnN0IGFyZ3MgPSBbXG4gICAgICAnYnVpbGQtZm9yLXRlc3RpbmcnLCAndGVzdC13aXRob3V0LWJ1aWxkaW5nJyxcbiAgICAgICctcHJvamVjdCcsIFdEQV9QUk9KRUNUKHRoaXMuYm9vdHN0cmFwUm9vdCksXG4gICAgICAnLXNjaGVtZScsIFJVTk5FUl9TQ0hFTUUsXG4gICAgICBESVNBQkxFX1NUT1JFX0FSRyxcbiAgICBdO1xuICAgIGNvbnN0IGVudiA9IE9iamVjdC5hc3NpZ24oe30sIHByb2Nlc3MuZW52LCB7XG4gICAgICBVU0VfUE9SVDogYCR7dGhpcy5wb3J0fWAsXG4gICAgICBVU0VfSE9TVDogdGhpcy5ob3N0LFxuICAgIH0pO1xuICAgIHRoaXMucHJvYyA9IG5ldyBTdWJQcm9jZXNzKHhjb2RlYnVpbGQsIGFyZ3MsIHtcbiAgICAgIGN3ZDogdGhpcy5ib290c3RyYXBSb290LFxuICAgICAgZW52LFxuICAgIH0pO1xuICAgIGlmICghdGhpcy5zaG93U2VydmVyTG9ncykge1xuICAgICAgbG9nLmluZm8oYE1hYzJEcml2ZXIgaG9zdCBwcm9jZXNzIGxvZ2dpbmcgaXMgZGlzYWJsZWQuIGAgK1xuICAgICAgICBgQWxsIHRoZSAke1hDT0RFQlVJTER9IG91dHB1dCBpcyBnb2luZyB0byBiZSBzdXBwcmVzc2VkLiBgICtcbiAgICAgICAgYFNldCB0aGUgJ3Nob3dTZXJ2ZXJMb2dzJyBjYXBhYmlsaXR5IHRvICd0cnVlJyBpZiB0aGlzIGlzIGFuIHVuZGVzaXJlZCBiZWhhdmlvcmApO1xuICAgIH1cbiAgICB0aGlzLnByb2Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgaWYgKCF0aGlzLnNob3dTZXJ2ZXJMb2dzKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgbGluZSA9IF8udHJpbShzdGRvdXQgfHwgc3RkZXJyKTtcbiAgICAgIGlmIChsaW5lKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgWyR7WENPREVCVUlMRH1dICR7bGluZX1gKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLnByb2Mub24oJ2V4aXQnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICBsb2cuaW5mbyhgTWFjMkRyaXZlciBob3N0IHByb2Nlc3MgaGFzIGV4aXRlZCB3aXRoIGNvZGUgJHtjb2RlfSwgc2lnbmFsICR7c2lnbmFsfWApO1xuICAgIH0pO1xuICAgIGxvZy5pbmZvKGBTdGFydGluZyBNYWMyRHJpdmVyIGhvc3QgcHJvY2VzczogJHtYQ09ERUJVSUxEfSAke3V0aWwucXVvdGUoYXJncyl9YCk7XG4gICAgYXdhaXQgdGhpcy5wcm9jLnN0YXJ0KDApO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgYXN5bmMgc3RvcCAoKSB7XG4gICAgaWYgKCF0aGlzLmlzUnVubmluZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGNoaWxkcmVuUGlkcyA9IGF3YWl0IHRoaXMubGlzdENoaWxkcmVuUGlkcygpO1xuICAgIGlmICghXy5pc0VtcHR5KGNoaWxkcmVuUGlkcykpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGV4ZWMoJ2tpbGwnLCBjaGlsZHJlblBpZHMpO1xuICAgICAgfSBjYXRjaCAoaWduKSB7fVxuICAgIH1cbiAgICBhd2FpdCB0aGlzLnByb2Muc3RvcCgnU0lHVEVSTScsIDMwMDApO1xuICB9XG5cbiAgYXN5bmMga2lsbCAoKSB7XG4gICAgaWYgKCF0aGlzLmlzUnVubmluZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGNoaWxkcmVuUGlkcyA9IGF3YWl0IHRoaXMubGlzdENoaWxkcmVuUGlkcygpO1xuICAgIGlmICghXy5pc0VtcHR5KGNoaWxkcmVuUGlkcykpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGV4ZWMoJ2tpbGwnLCBbJy05JywgLi4uY2hpbGRyZW5QaWRzXSk7XG4gICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnByb2Muc3RvcCgnU0lHS0lMTCcpO1xuICAgIH0gY2F0Y2ggKGlnbikge31cbiAgfVxufVxuXG5jbGFzcyBXREFNYWNTZXJ2ZXIge1xuICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgdGhpcy5wcm9jZXNzID0gbnVsbDtcbiAgICB0aGlzLnNlcnZlclN0YXJ0dXBUaW1lb3V0TXMgPSBTVEFSVFVQX1RJTUVPVVRfTVM7XG4gICAgdGhpcy5wcm94eSA9IG51bGw7XG5cbiAgICAvLyBUbyBoYW5kbGUgaWYgdGhlIFdEQU1hYyBzZXJ2ZXIgaXMgcHJveHlpbmcgcmVxdWVzdHMgdG8gYSByZW1vdGUgV0RBTWFjIGFwcCBpbnN0YW5jZVxuICAgIHRoaXMuaXNQcm94eWluZ1RvUmVtb3RlU2VydmVyID0gZmFsc2U7XG4gIH1cblxuICBhc3luYyBpc1Byb3h5UmVhZHkgKHRocm93T25FeGl0ID0gdHJ1ZSkge1xuICAgIGlmICghdGhpcy5wcm94eSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnByb3h5LmNvbW1hbmQoJy9zdGF0dXMnLCAnR0VUJyk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmICh0aHJvd09uRXhpdCAmJiB0aGlzLnByb3h5LmRpZFByb2Nlc3NFeGl0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihlcnIubWVzc2FnZSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cblxuICAvKipcbiAgICogQHR5cGVkZWYge09iamVjdH0gUHJveHlQcm9wZXJ0aWVzXG4gICAqXG4gICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBzY2hlbWUgLSBUaGUgc2NoZW1lIHByb3h5IHRvLlxuICAgKiBAcHJvcGVydHkge3N0cmluZ30gaG9zdCAtIFRoZSBob3N0IG5hbWUgcHJveHkgdG8uXG4gICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwb3J0IC0gVGhlIHBvcnQgbnVtYmVyIHByb3h5IHRvLlxuICAgKiBAcHJvcGVydHkge3N0cmluZ30gcGF0aCAtIFRoZSBwYXRoIHByb3h5IHRvLlxuICAgKi9cblxuICAvKipcbiAgICogUmV0dXJucyBwcm94eSBpbmZvcm1hdGlvbiB3aGVyZSBXREFNYWNTZXJ2ZXIgcHJveHkgdG8uXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBjYXBzIC0gVGhlIGNhcGFiaWxpdGllcyBpbiB0aGUgc2Vzc2lvbi5cbiAgICogQHJldHVybiB7UHJveHlQcm9wZXJ0aWVzfVxuICAgKiBAdGhyb3dzIEVycm9yIGlmICd3ZWJEcml2ZXJBZ2VudE1hY1VybCcgaGFkIGludmFsaWQgVVJMXG4gICAqL1xuICBwYXJzZVByb3h5UHJvcGVydGllcyAoY2Fwcykge1xuICAgIGxldCBzY2hlbWUgPSAnaHR0cCc7XG4gICAgaWYgKCFjYXBzLndlYkRyaXZlckFnZW50TWFjVXJsKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzY2hlbWUsXG4gICAgICAgIHNlcnZlcjogKHRoaXMucHJvY2Vzcz8uaG9zdCA/PyBjYXBzLnN5c3RlbUhvc3QpID8/IERFRkFVTFRfU1lTVEVNX0hPU1QsXG4gICAgICAgIHBvcnQ6ICh0aGlzLnByb2Nlc3M/LnBvcnQgPz8gY2Fwcy5zeXN0ZW1Qb3J0KSA/PyBERUZBVUxUX1NZU1RFTV9QT1JULFxuICAgICAgICBwYXRoOiAnJ1xuICAgICAgfTtcbiAgICB9XG5cbiAgICBsZXQgcGFyc2VkVXJsO1xuICAgIHRyeSB7XG4gICAgICBwYXJzZWRVcmwgPSBuZXcgdXJsLlVSTChjYXBzLndlYkRyaXZlckFnZW50TWFjVXJsKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYHdlYkRyaXZlckFnZW50TWFjVXJsLCAnJHtjYXBzLndlYkRyaXZlckFnZW50TWFjVXJsfScsIGAgK1xuICAgICAgICBgaW4gdGhlIGNhcGFiaWxpdGllcyBpcyBpbnZhbGlkLiAke2UubWVzc2FnZX1gKTtcbiAgICB9XG5cbiAgICBjb25zdCB7IHByb3RvY29sLCBob3N0bmFtZSwgcG9ydCwgcGF0aG5hbWUgfSA9IHBhcnNlZFVybDtcbiAgICBpZiAoXy5pc1N0cmluZyhwcm90b2NvbCkpIHtcbiAgICAgIHNjaGVtZSA9IHByb3RvY29sLnNwbGl0KCc6JylbMF07XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBzY2hlbWUsXG4gICAgICBzZXJ2ZXI6IGhvc3RuYW1lID8/IERFRkFVTFRfU1lTVEVNX0hPU1QsXG4gICAgICBwb3J0OiBfLmlzRW1wdHkocG9ydCkgPyBERUZBVUxUX1NZU1RFTV9QT1JUIDogXy5wYXJzZUludChwb3J0KSxcbiAgICAgIHBhdGg6IHBhdGhuYW1lID09PSAnLycgPyAnJyA6IHBhdGhuYW1lXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvbiAoY2Fwcykge1xuICAgIHRoaXMuc2VydmVyU3RhcnR1cFRpbWVvdXRNcyA9IGNhcHMuc2VydmVyU3RhcnR1cFRpbWVvdXQgPz8gdGhpcy5zZXJ2ZXJTdGFydHVwVGltZW91dE1zO1xuXG4gICAgdGhpcy5pc1Byb3h5aW5nVG9SZW1vdGVTZXJ2ZXIgPSAhIWNhcHMud2ViRHJpdmVyQWdlbnRNYWNVcmw7XG5cbiAgICBsZXQgd2FzUHJvY2Vzc0luaXROZWNlc3Nhcnk7XG4gICAgaWYgKHRoaXMuaXNQcm94eWluZ1RvUmVtb3RlU2VydmVyKSB7XG4gICAgICBpZiAodGhpcy5wcm9jZXNzKSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJvY2Vzcy5raWxsKCk7XG4gICAgICAgIGF3YWl0IGNsZWFudXBPYnNvbGV0ZVByb2Nlc3NlcygpO1xuICAgICAgICB0aGlzLnByb2Nlc3MgPSBudWxsO1xuICAgICAgfVxuXG4gICAgICB3YXNQcm9jZXNzSW5pdE5lY2Vzc2FyeSA9IGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIXRoaXMucHJvY2Vzcykge1xuICAgICAgICB0aGlzLnByb2Nlc3MgPSBuZXcgV0RBTWFjUHJvY2VzcygpO1xuICAgICAgfVxuICAgICAgd2FzUHJvY2Vzc0luaXROZWNlc3NhcnkgPSBhd2FpdCB0aGlzLnByb2Nlc3MuaW5pdChjYXBzKTtcbiAgICB9XG5cbiAgICBpZiAod2FzUHJvY2Vzc0luaXROZWNlc3NhcnkgfHwgdGhpcy5pc1Byb3h5aW5nVG9SZW1vdGVTZXJ2ZXIgfHwgIXRoaXMucHJveHkpIHtcbiAgICAgIGNvbnN0IHtzY2hlbWUsIHNlcnZlciwgcG9ydCwgcGF0aH0gPSB0aGlzLnBhcnNlUHJveHlQcm9wZXJ0aWVzKGNhcHMpO1xuICAgICAgdGhpcy5wcm94eSA9IG5ldyBXREFNYWNQcm94eSh7XG4gICAgICAgIHNjaGVtZSxcbiAgICAgICAgc2VydmVyLFxuICAgICAgICBwb3J0LFxuICAgICAgICBiYXNlOiBwYXRoLFxuICAgICAgICBrZWVwQWxpdmU6IHRydWUsXG4gICAgICB9KTtcbiAgICAgIHRoaXMucHJveHkuZGlkUHJvY2Vzc0V4aXQgPSBmYWxzZTtcblxuICAgICAgaWYgKHRoaXMucHJvY2Vzcykge1xuICAgICAgICB0aGlzLnByb2Nlc3MucHJvYy5vbignZXhpdCcsICgpID0+IHtcbiAgICAgICAgICB0aGlzLnByb3h5LmRpZFByb2Nlc3NFeGl0ID0gdHJ1ZTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHRpbWVyID0gbmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IGF3YWl0IHRoaXMuaXNQcm94eVJlYWR5KCksIHtcbiAgICAgICAgICB3YWl0TXM6IHRoaXMuc2VydmVyU3RhcnR1cFRpbWVvdXRNcyxcbiAgICAgICAgICBpbnRlcnZhbE1zOiAxMDAwLFxuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgaWYgKHRoaXMucHJvY2Vzcz8uaXNSdW5uaW5nKSB7XG4gICAgICAgICAgLy8gYXZvaWQgXCJmcm96ZW5cIiBwcm9jZXNzZXMsXG4gICAgICAgICAgYXdhaXQgdGhpcy5wcm9jZXNzLmtpbGwoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoL0NvbmRpdGlvbiB1bm1ldC8udGVzdChlLm1lc3NhZ2UpKSB7XG4gICAgICAgICAgY29uc3QgbXNnID0gdGhpcy5pc1Byb3h5aW5nVG9SZW1vdGVTZXJ2ZXJcbiAgICAgICAgICAgID8gYE5vIHJlc3BvbnNlIGZyb20gJyR7c2NoZW1lfTovLyR7c2VydmVyfToke3BvcnR9JHtwYXRofScgd2l0aGluICR7dGhpcy5zZXJ2ZXJTdGFydHVwVGltZW91dE1zfW1zIHRpbWVvdXQuYCArXG4gICAgICAgICAgICBgUGxlYXNlIG1ha2Ugc3VyZSB0aGUgcmVtb3RlIHNlcnZlciBpcyBydW5uaW5nIGFuZCBhY2Nlc3NpYmxlIGJ5IEFwcGl1bWBcbiAgICAgICAgICAgIDogYE1hYzJEcml2ZXIgc2VydmVyIGlzIG5vdCBsaXN0ZW5pbmcgd2l0aGluICR7dGhpcy5zZXJ2ZXJTdGFydHVwVGltZW91dE1zfW1zIHRpbWVvdXQuIGAgK1xuICAgICAgICAgICAgYFRyeSB0byBpbmNyZWFzZSB0aGUgdmFsdWUgb2YgJ3NlcnZlclN0YXJ0dXBUaW1lb3V0JyBjYXBhYmlsaXR5LCBjaGVjayB0aGUgc2VydmVyIGxvZ3MgYCArXG4gICAgICAgICAgICBgYW5kIG1ha2Ugc3VyZSB0aGUgJHtYQ09ERUJVSUxEfSBob3N0IHByb2Nlc3MgY291bGQgYmUgc3RhcnRlZCBtYW51YWxseSBmcm9tIGEgdGVybWluYWxgO1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihtc2cpO1xuICAgICAgICB9XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLnByb2Nlc3MpIHtcbiAgICAgICAgY29uc3QgcGlkID0gdGhpcy5wcm9jZXNzLnBpZDtcbiAgICAgICAgY29uc3QgY2hpbGRyZW5QaWRzID0gYXdhaXQgdGhpcy5wcm9jZXNzLmxpc3RDaGlsZHJlblBpZHMoKTtcbiAgICAgICAgUlVOTklOR19QUk9DRVNTX0lEUy5wdXNoKC4uLmNoaWxkcmVuUGlkcywgcGlkKTtcbiAgICAgICAgdGhpcy5wcm9jZXNzLnByb2Mub24oJ2V4aXQnLCAoKSA9PiB2b2lkIF8ucHVsbChSVU5OSU5HX1BST0NFU1NfSURTLCBwaWQpKTtcbiAgICAgICAgbG9nLmluZm8oYFRoZSBob3N0IHByb2Nlc3MgaXMgcmVhZHkgd2l0aGluICR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc01pbGxpU2Vjb25kcy50b0ZpeGVkKDApfW1zYCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5pbmZvKCdUaGUgaG9zdCBwcm9jZXNzIGhhcyBhbHJlYWR5IGJlZW4gbGlzdGVuaW5nLiBQcm9jZWVkaW5nIHdpdGggc2Vzc2lvbiBjcmVhdGlvbicpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMucHJveHkuY29tbWFuZCgnL3Nlc3Npb24nLCAnUE9TVCcsIHtcbiAgICAgIGNhcGFiaWxpdGllczoge1xuICAgICAgICBmaXJzdE1hdGNoOiBbe31dLFxuICAgICAgICBhbHdheXNNYXRjaDogY2FwcyxcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHN0b3BTZXNzaW9uICgpIHtcbiAgICBpZiAoIXRoaXMuaXNQcm94eWluZ1RvUmVtb3RlU2VydmVyICYmICEodGhpcy5wcm9jZXNzPy5pc1J1bm5pbmcpKSB7XG4gICAgICBsb2cuaW5mbyhgTWFjMkRyaXZlciBzZXNzaW9uIGNhbm5vdCBiZSBzdG9wcGVkLCBiZWNhdXNlIHRoZSBzZXJ2ZXIgaXMgbm90IHJ1bm5pbmdgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wcm94eT8uc2Vzc2lvbklkKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnByb3h5LmNvbW1hbmQoYC9zZXNzaW9uLyR7dGhpcy5wcm94eS5zZXNzaW9uSWR9YCwgJ0RFTEVURScpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cuaW5mbyhgTWFjMkRyaXZlciBzZXNzaW9uIGNhbm5vdCBiZSBkZWxldGVkLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmNvbnN0IFdEQV9NQUNfU0VSVkVSID0gbmV3IFdEQU1hY1NlcnZlcigpO1xuXG5leHBvcnQgZGVmYXVsdCBXREFfTUFDX1NFUlZFUjtcbiJdLCJmaWxlIjoibGliL3dkYS1tYWMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
